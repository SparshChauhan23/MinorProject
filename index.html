<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Hub</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Load Icons (for stars, etc.) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <!-- 5. Custom Styles for Re-usable Classes -->
    <style>
        /* Simple scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Re-usable form classes */
        .form-input {
            @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700;
        }
        
        /* Re-usable button classes */
        .btn {
            @apply w-full px-4 py-2 text-white font-semibold rounded-md shadow-md transition-colors;
        }
        .btn-primary { @apply bg-blue-500 hover:bg-blue-600; }
        .btn-secondary { @apply bg-gray-500 hover:bg-gray-600; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600; }
        .btn-disabled { @apply bg-gray-400 cursor-not-allowed; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <!-- React app will mount here -->
    <div id="root"></div>

    <!-- 6. Our Entire React Application -->
    <script type="text/babel">
        // --- Globals ---
        const API_URL = 'http://localhost:5000/api';
        const { useState, useEffect, useCallback } = React;

        // --- Re-usable Components ---
        const StarRating = ({ rating = 0 }) => {
            const totalStars = 5;
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 !== 0; 
            const emptyStars = totalStars - fullStars - (halfStar ? 1 : 0);
            return (
                <div className="flex items-center text-yellow-400">
                    {[...Array(fullStars)].map((_, i) => <ion-icon key={`full-${i}`} name="star"></ion-icon>)}
                    {halfStar && <ion-icon key="half" name="star-half-outline"></ion-icon>}
                    {[...Array(emptyStars)].map((_, i) => <ion-icon key={`empty-${i}`} name="star-outline"></ion-icon>)}
                </div>
            );
        };
        
        // --- Main App: The Router ---
        // This component manages if we see the Login page or the Main App
        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [currentUser, setCurrentUser] = useState(null);

            // This effect runs on load to check if we are already logged in
            useEffect(() => {
                const savedToken = localStorage.getItem('token');
                const savedUser = localStorage.getItem('user');
                if (savedToken && savedUser) {
                    try {
                        setToken(savedToken);
                        setCurrentUser(JSON.parse(savedUser));
                    } catch (e) {
                        console.error("Failed to parse saved user:", e);
                        localStorage.clear(); // Clear bad data
                    }
                }
            }, []);

            // Called by AuthPage when login is successful
            const handleLogin = (token, user) => {
                setToken(token);
                setCurrentUser(user);
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
            };

            // Called by MainApp when user clicks logout
            const handleLogout = () => {
                setToken(null);
                setCurrentUser(null);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            };
            
            // This is our simple "Router".
            // If we have a user, show the main app. If not, show the login page.
            return (
                <div>
                    {!currentUser ? (
                        <AuthPage onLogin={handleLogin} />
                    ) : (
                        <MainApp 
                            currentUser={currentUser} 
                            token={token} 
                            onLogout={handleLogout} 
                        />
                    )}
                </div>
            );
        }
        
        // --- Authentication Page Component ---
        // This component handles both Login and Registration
        function AuthPage({ onLogin }) {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                
                const url = isLoginMode ? `${API_URL}/auth/login` : `${API_URL}/auth/register`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Something went wrong');
                    }
                    
                    if (isLoginMode) {
                        onLogin(data.token, data.user); // Log the user in
                    } else {
                        setMessage('Registration successful! Please log in.');
                        setIsLoginMode(true);
                        setPassword(''); // Clear password field
                    }
                    
                } catch (err) {
                    setError(err.message);
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                        <h2 className="text-2xl font-bold text-center mb-6">
                            {isLoginMode ? 'Login' : 'Sign Up'}
                        </h2>
                        <form onSubmit={handleSubmit}>
                            {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                            {message && <p className="text-green-500 text-sm mb-4">{message}</p>}
                            <div className="mb-4">
                                <label className="form-label" htmlFor="email">Email</label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    className="form-input" 
                                    value={email} 
                                    onChange={(e) => setEmail(e.target.value)} 
                                    required 
                                />
                            </div>
                            <div className="mb-6">
                                <label className="form-label" htmlFor="password">Password</label>
                                <input 
                                    type="password" 
                                    id="password" 
                                    className="form-input" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    required 
                                />
                            </div>
                            <button type="submit" className="btn btn-primary">
                                {isLoginMode ? 'Login' : 'Sign Up'}
                            </button>
                        </form>
                        <button 
                            onClick={() => {
                                setIsLoginMode(!isLoginMode);
                                setError('');
                                setMessage('');
                            }}
                            className="mt-4 text-center w-full text-sm text-blue-500 hover:underline"
                        >
                            {isLoginMode ? 'Need an account? Sign Up' : 'Have an account? Login'}
                        </button>
                    </div>
                </div>
            );
        }

        // --- Main Application Component (The one you're used to) ---
        function MainApp({ currentUser, token, onLogout }) {
            const [products, setProducts] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false); // Admin "Add Product" modal

            // Fetch products from the public endpoint
            const fetchProducts = useCallback(() => {
                 fetch(`${API_URL}/products`)
                    .then(response => response.json())
                    .then(data => setProducts(data))
                    .catch(error => console.error("Error fetching products:", error));
            }, []);
            
            // Fetch products when the component loads
            useEffect(() => {
                fetchProducts();
            }, [fetchProducts]);

            // Callback for when a new product is added
            const handleProductAdded = (newProduct) => {
                setProducts([...products, newProduct]);
                setShowAddForm(false);
            };
            
            // Callback for when a product is deleted
            const handleProductDeleted = (deletedProductId) => {
                setProducts(products.filter(p => p.productId !== deletedProductId));
                setSelectedProduct(null); // Close the modal
            };
            
            // Callback for when stock is updated
            const handleStockUpdated = (updatedProduct) => {
                // Update the product in the main list
                setProducts(products.map(p => 
                    p.productId === updatedProduct.productId ? updatedProduct : p
                ));
                // Update the product in the modal
                setSelectedProduct(updatedProduct);
            };
            
            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <nav className="bg-white shadow-md sticky top-0 z-10">
                        <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800">Product Hub</h1>
                                <p className="text-gray-600">Welcome, {currentUser.email} ({currentUser.role})</p>
                            </div>
                            <div>
                                {/* Show "Add Product" button only for admins */}
                                {currentUser.role === 'admin' && (
                                    <button 
                                        className="btn btn-success mr-4"
                                        onClick={() => setShowAddForm(true)}
                                    >
                                        Add Product
                                    </button>
                                )}
                                <button className="btn btn-secondary" onClick={onLogout}>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Main Product Grid */}
                    <main className="container mx-auto px-6 py-8">
                        <h2 className="text-2xl font-semibold text-gray-700 mb-6">Full Product Inventory</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {products.map(product => (
                                <ProductCard 
                                    key={product.productId} 
                                    product={product} 
                                    onView={setSelectedProduct} 
                                />
                            ))}
                        </div>
                    </main>
                    
                    {/* Modals */}
                    {selectedProduct && (
                        <ProductModal 
                            product={selectedProduct} 
                            onClose={() => setSelectedProduct(null)}
                            onStockUpdated={handleStockUpdated}
                            onProductDeleted={handleProductDeleted}
                            onReviewSubmitted={fetchProducts} // Refetch all products to update ratings
                            onOrderPlaced={fetchProducts} // Refetch to update stock
                            currentUser={currentUser}
                            token={token}
                        />
                    )}
                    
                    {showAddForm && (
                        <AddProductForm
                            token={token}
                            onClose={() => setShowAddForm(false)}
                            onProductAdded={handleProductAdded}
                        />
                    )}
                </div>
            );
        }

        // --- Product Card Component ---
        function ProductCard({ product, onView }) {
            return (
                <div className="bg-white rounded-lg shadow-lg overflow-hidden transition-transform transform hover:scale-105 duration-300 flex flex-col">
                    <img src={product.imageUrl} alt={product.name} className="w-full h-56 object-cover" />
                    <div className="p-4 flex flex-col flex-grow">
                        <h3 className="text-lg font-semibold text-gray-800 truncate">{product.name}</h3>
                        <p className="text-gray-600 text-sm mt-1">{product.category}</p>
                        <div className="flex items-center gap-2 mt-2">
                            <StarRating rating={product.averageRating} />
                            <span className="text-xs text-gray-500">({product.reviewCount} reviews)</span>
                        </div>
                        <p className="text-sm font-bold text-gray-700 mt-2">Stock: {product.stock_quantity}</p>
                        <div className="flex-grow"></div>
                        <div className="flex justify-between items-center mt-4">
                            <span className="text-xl font-bold text-blue-600">${product.price.toFixed(2)}</span>
                            <button 
                                onClick={() => onView(product)}
                                className="px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-md shadow-md hover:bg-blue-600"
                            >
                                View
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Product Modal Component (Heavily Updated for Roles) ---
        function ProductModal({ product, onClose, onStockUpdated, onProductDeleted, onReviewSubmitted, onOrderPlaced, currentUser, token }) {
            const [recommendations, setRecommendations] = useState([]);
            const [reviews, setReviews] = useState([]);
            const [view, setView] = useState('details'); // 'details' or 'reviews'
            const [currentProduct, setCurrentProduct] = useState(product);
            
            // State for child modals
            const [showBuyForm, setShowBuyForm] = useState(false);

            // Fetch data when the product in the modal changes
            useEffect(() => {
                // Fetch Recommendations
                fetch(`${API_URL}/recommendations/${currentProduct.productId}`)
                    .then(res => res.json())
                    .then(setRecommendations);
                // Fetch Reviews
                fetch(`${API_URL}/reviews/${currentProduct.productId}`)
                    .then(res => res.json())
                    .then(setReviews);
                // Reset to details tab
                setView('details');
            }, [currentProduct]);

            // --- ADMIN ACTION: Update Stock ---
            const handleStockClick = () => {
                const newStock = prompt("Enter new stock quantity:", currentProduct.stock_quantity);
                const stock = parseInt(newStock);
                if (newStock === null || isNaN(stock) || stock < 0) {
                    alert("Please enter a valid, non-negative stock number.");
                    return;
                }
                
                // Send the protected request
                fetch(`${API_URL}/products/${currentProduct.productId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Send the token
                    },
                    body: JSON.stringify({ new_stock: stock }),
                })
                .then(res => res.json())
                .then(updatedProduct => {
                    onStockUpdated(updatedProduct); // Pass up to MainApp
                    setCurrentProduct(updatedProduct); // Update local modal state
                });
            };

            // --- ADMIN ACTION: Delete Product ---
            const handleDeleteClick = async () => {
                // NOTE: Using alert() for confirmation is bad practice as it's
                // often blocked. A custom modal is better.
                // For this project, we'll proceed without confirmation.
                try {
                    const response = await fetch(`${API_URL}/products/${currentProduct.productId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error("Failed to delete.");
                    
                    onProductDeleted(currentProduct.productId);
                } catch (err) {
                    alert("Failed to delete product.");
                }
            };
            
            // --- USER ACTION: New Review Submitted ---
            const handleNewReview = (newReview) => {
                setReviews([newReview, ...reviews]);
                // Recalculate average and count for the modal
                const newTotalRating = reviews.reduce((acc, r) => acc + r.rating, 0) + newReview.rating;
                const newReviewCount = reviews.length + 1;
                setCurrentProduct(prev => ({
                    ...prev,
                    reviewCount: newReviewCount,
                    averageRating: newTotalRating / newReviewCount
                }));
                onReviewSubmitted(); // Tell MainApp to refetch all products
            };
            
            // --- USER ACTION: Order Placed ---
            const handleOrderPlaced = () => {
                setShowBuyForm(false);
                onOrderPlaced(); // Tell MainApp to refetch to update stock
                // We need to refetch the product to update stock in the modal
                fetch(`${API_URL}/products/${currentProduct.productId}`)
                    .then(res => res.json())
                    .then(setCurrentProduct);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    {/* Main Modal Container */}
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden" onClick={(e) => e.stopPropagation()}>
                        
                        {/* Modal Header */}
                        <div className="flex justify-between items-center p-4 border-b border-gray-200">
                            <h2 className="text-2xl font-semibold text-gray-800">{currentProduct.name}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        </div>

                        {/* Modal Body */}
                        <div className="flex-grow overflow-y-auto p-6 flex flex-col lg:flex-row gap-6">
                            
                            {/* Left Panel: Product Info */}
                            <div className="w-full lg:w-1/2">
                                <img src={currentProduct.imageUrl} alt={currentProduct.name} className="w-full h-80 object-cover rounded-lg shadow-md" />
                                <div className="mt-4">
                                    <p className="text-gray-700 mt-2">{currentProduct.description}</p>
                                    <div className="text-3xl font-bold text-blue-600 my-4">${currentProduct.price.toFixed(2)}</div>
                                    <div className="flex items-center gap-2 mb-4">
                                        <StarRating rating={currentProduct.averageRating} />
                                        <span className="text-sm text-gray-600">{currentProduct.averageRating.toFixed(1)} ({currentProduct.reviewCount} reviews)</span>
                                    </div>
                                    <div className="text-lg font-semibold text-gray-700">
                                        Stock: {currentProduct.stock_quantity}
                                    </div>
                                    
                                    {/* --- ACTION BUTTONS (ROLE-BASED) --- */}
                                    <div className="mt-4 space-y-2">
                                        {currentUser.role === 'user' && (
                                            <button 
                                                className={`btn btn-primary ${currentProduct.stock_quantity < 1 ? 'btn-disabled' : ''}`}
                                                onClick={() => setShowBuyForm(true)}
                                                disabled={currentProduct.stock_quantity < 1}
                                            >
                                                {currentProduct.stock_quantity < 1 ? 'Out of Stock' : 'Buy Now'}
                                            </button>
                                        )}
                                        {currentUser.role === 'admin' && (
                                            <>
                                                <button onClick={handleStockClick} className="btn btn-success">Update Stock</button>
                                                <button onClick={handleDeleteClick} className="btn btn-danger">Delete Product</button>
                                            </>
                                        )}
                                    </div>
                                    <div className="text-sm text-gray-500 mt-2">Product ID: {currentProduct.productId}</div>
                                </div>
                            </div>

                            {/* Right Panel: Tabs (Recommendations & Reviews) */}
                            <div className="w-full lg:w-1/2 lg:border-l lg:pl-6">
                                <div className="flex border-b mb-4">
                                    <button className={`py-2 px-4 font-semibold ${view === 'details' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`} onClick={() => setView('details')}>Recommendations</button>
                                    <button className={`py-2 px-4 font-semibold ${view === 'reviews' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`} onClick={() => setView('reviews')}>Reviews ({reviews.length})</button>
                                </div>
                                {view === 'details' ? (
                                    <RecommendationList recommendations={recommendations} onViewRecommended={setCurrentProduct} />
                                ) : (
                                    <ReviewPane 
                                        productId={currentProduct.productId}
                                        reviews={reviews} 
                                        onNewReview={handleNewReview}
                                        canReview={currentUser.role === 'user'}
                                        token={token}
                                    />
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Child Modal: Buy Form (appears on top of main modal) */}
                    {showBuyForm && (
                        <BuyForm
                            product={currentProduct}
                            token={token}
                            onClose={() => setShowBuyForm(false)}
                            onOrderPlaced={handleOrderPlaced}
                        />
                    )}
                </div>
            );
        }
        
        // --- Recommendation List Component (in modal) ---
        const RecommendationList = ({ recommendations, onViewRecommended }) => (
            <div className="space-y-4">
                <h3 className="text-xl font-semibold text-gray-800 mb-4">You might also like...</h3>
                {recommendations.length > 0 ? recommendations.map(rec => (
                    <div 
                        key={rec.productId} 
                        className="flex items-center gap-4 p-2 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 cursor-pointer" 
                        onClick={() => onViewRecommended(rec)}
                    >
                        <img src={rec.imageUrl} alt={rec.name} className="w-20 h-20 object-cover rounded-md" />
                        <div>
                            <h4 className="font-semibold text-gray-800">{rec.name}</h4>
                            <p className="text-blue-600 font-bold">${rec.price.toFixed(2)}</p>
                            <div className="flex items-center gap-1 text-sm"><StarRating rating={rec.averageRating} /><span className="text-gray-500">({rec.reviewCount})</span></div>
                        </div>
                    </div>
                )) : <p className="text-gray-500">Finding recommendations...</p>}
            </div>
        );

        // --- Review Pane (List + Form) Component (in modal) ---
        const ReviewPane = ({ productId, reviews, onNewReview, canReview, token }) => (
            <div className="flex flex-col h-[50vh]"> {/* Fixed height to make list scrollable */}
                <h3 className="text-xl font-semibold text-gray-800 mb-4">Customer Reviews</h3>
                {/* Only show AddReviewForm to users */}
                {canReview && <AddReviewForm productId={productId} onNewReview={onNewReview} token={token} />}
                
                {/* Review List */}
                <div className="flex-grow overflow-y-auto mt-4 space-y-4 pr-2">
                    {reviews.length > 0 ? reviews.map(review => (
                        <div key={review._id} className="p-3 bg-gray-50 rounded-lg border">
                            <div className="flex justify-between items-center mb-1">
                                <h4 className="font-semibold text-gray-900">{review.authorName}</h4>
                                <span className="text-xs text-gray-500">{new Date(review.createdAt).toLocaleDateString()}</span>
                            </div>
                            <StarRating rating={review.rating} />
                            <p className="text-gray-700 mt-2">{review.comment}</p>
                        </div>
                    )) : <p className="text-gray-500 text-center mt-4">No reviews yet. {canReview && "Be the first!"}</p>}
                </div>
            </div>
        );
        
        // --- Add Review Form Component ---
        const AddReviewForm = ({ productId, onNewReview, token }) => {
            const [rating, setRating] = useState(5);
            const [comment, setComment] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const response = await fetch(`${API_URL}/reviews`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // Send token
                        },
                        body: JSON.stringify({ productId, rating: parseInt(rating), comment })
                    });
                    const newReview = await response.json();
                    if (!response.ok) throw new Error(newReview.message || "Failed to submit.");
                    
                    onNewReview(newReview);
                    setRating(5);
                    setComment('');
                } catch (err) {
                    alert("Error submitting review: " + err.message);
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <form onSubmit={handleSubmit} className="p-3 border rounded-lg bg-white">
                    <h4 className="font-semibold mb-2">Leave a Review</h4>
                    {/* Note: Name is removed, it comes from the token now */}
                    <div className="mb-2">
                        <label className="form-label" htmlFor="rating">Rating</label>
                        <select id="rating" value={rating} onChange={(e) => setRating(e.target.value)} className="form-input">
                            <option value="5">5 Stars (Excellent)</option>
                            <option value="4">4 Stars (Good)</option>
                            <option value="3">3 Stars (Average)</option>
                            <option value="2">2 Stars (Poor)</option>
                            <option value="1">1 Star (Terrible)</option>
                        </select>
                    </div>
                    <div className="mb-2">
                        <label className="form-label" htmlFor="comment">Comment</label>
                        <textarea id="comment" rows="3" value={comment} onChange={(e) => setComment(e.target.value)} className="form-input" required></textarea>
                    </div>
                    <button type="submit" disabled={isSubmitting} className={`btn btn-primary ${isSubmitting ? 'btn-disabled' : ''}`}>
                        {isSubmitting ? 'Submitting...' : 'Submit Review'}
                    </button>
                </form>
            );
        };
        
        // --- NEW: Add Product Form (Modal) ---
        function AddProductForm({ token, onClose, onProductAdded }) {
            const [formData, setFormData] = useState({
                productId: '', name: '', description: '', price: '', category: '', stock_quantity: '', imageUrl: ''
            });
            
            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Send protected request to admin-only endpoint
                    const response = await fetch(`${API_URL}/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formData)
                    });
                    const newProduct = await response.json();
                    if (!response.ok) throw new Error(newProduct.message || "Failed to add product");
                    onProductAdded(newProduct);
                } catch (err) {
                    alert("Error: " + err.message);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-4">Add New Product</h2>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <input name="productId" value={formData.productId} onChange={handleChange} placeholder="Product ID (e.g., SKU1004)" className="form-input" required />
                            <input name="name" value={formData.name} onChange={handleChange} placeholder="Product Name" className="form-input" required />
                            <textarea name="description" value={formData.description} onChange={handleChange} placeholder="Description" className="form-input" rows="3"></textarea>
                            <input name="price" type="number" step="0.01" value={formData.price} onChange={handleChange} placeholder="Price (e.g., 29.99)" className="form-input" required />
                            <input name="category" value={formData.category} onChange={handleChange} placeholder="Category" className="form-input" required />
                            <input name="stock_quantity" type="number" value={formData.stock_quantity} onChange={handleChange} placeholder="Stock Quantity" className="form-input" required />
                            <input name="imageUrl" value={formData.imageUrl} onChange={handleChange} placeholder="Image URL (http://...)" className="form-input" />
                            <div className="flex justify-end space-x-2 pt-2">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // --- NEW: Buy Form (Modal) ---
        function BuyForm({ product, token, onClose, onOrderPlaced }) {
            const [name, setName] = useState('');
            const [address, setAddress] = useState('');
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Send protected request to user-only endpoint
                    const response = await fetch(`${API_URL}/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            productId: product.productId,
                            customerName: name,
                            shippingAddress: address
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || "Failed to place order.");
                    
                    alert("Order placed successfully!");
                    onOrderPlaced();
                    
                } catch (err) {
                    alert("Error: " + err.message);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-4">Buy: {product.name}</h2>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <p>Please enter your shipping details to complete the purchase.</p>
                            <div>
                                <label className="form-label" htmlFor="name">Full Name</label>
                                <input id="name" value={name} onChange={(e) => setName(e.target.value)} className="form-input" required />
                            </div>
                            <div>
                                <label className="form-label" htmlFor="address">Shipping Address</label>
                                <textarea id="address" rows="3" value={address} onChange={(e) => setAddress(e.target.value)} className="form-input" required></textarea>
                            </div>
                            <div className="flex justify-end space-x-2 pt-2">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary">Confirm Purchase</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        // --- Mount the App ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>